# ─── Stage 1: Build vLLM CPU wheel ──────────────────────────────
FROM ubuntu:22.04 AS builder

ARG PYTHON_VERSION=3.12
ARG PIP_EXTRA_INDEX_URL="https://download.pytorch.org/whl/cpu"

WORKDIR /workspace

# System deps (matches official Dockerfile.cpu)
RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        sudo ccache git curl wget ca-certificates \
        gcc-12 g++-12 libtcmalloc-minimal4 libnuma-dev \
        ffmpeg libsm6 libxext6 libgl1 jq lsof && \
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 \
        --slave /usr/bin/g++ g++ /usr/bin/g++-12 && \
    curl -LsSf https://astral.sh/uv/install.sh | sh && \
    rm -rf /var/lib/apt/lists/*

ENV CC=/usr/bin/gcc-12
ENV CXX=/usr/bin/g++-12
ENV CCACHE_DIR=/root/.cache/ccache
ENV CMAKE_CXX_COMPILER_LAUNCHER=ccache
ENV PATH="/root/.local/bin:$PATH"

# Create venv (official approach — uv needs a venv, not --system)
ENV VIRTUAL_ENV="/opt/venv"
RUN uv venv --python ${PYTHON_VERSION} --seed ${VIRTUAL_ENV}
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

ENV UV_HTTP_TIMEOUT=500
ENV PIP_EXTRA_INDEX_URL=${PIP_EXTRA_INDEX_URL}
ENV UV_EXTRA_INDEX_URL=${PIP_EXTRA_INDEX_URL}
ENV UV_INDEX_STRATEGY="unsafe-best-match"
ENV UV_LINK_MODE="copy"

# Clone vLLM
RUN git clone --depth 1 https://github.com/vllm-project/vllm.git /workspace/vllm

# Install runtime Python deps
RUN uv pip install --upgrade pip && \
    uv pip install \
        -r /workspace/vllm/requirements/common.txt \
        -r /workspace/vllm/requirements/cpu.txt

# Install build deps
RUN uv pip install -r /workspace/vllm/requirements/cpu-build.txt

# Build the wheel
WORKDIR /workspace/vllm
RUN VLLM_TARGET_DEVICE=cpu python3 setup.py bdist_wheel --dist-dir=dist

# ─── Stage 2: Runtime ───────────────────────────────────────────
FROM ubuntu:22.04

ARG PYTHON_VERSION=3.12
ARG PIP_EXTRA_INDEX_URL="https://download.pytorch.org/whl/cpu"

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
        curl ca-certificates libtcmalloc-minimal4 libnuma-dev g++ && \
    curl -LsSf https://astral.sh/uv/install.sh | sh && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/root/.local/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"
RUN uv venv --python ${PYTHON_VERSION} --seed ${VIRTUAL_ENV}
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

ENV PIP_EXTRA_INDEX_URL=${PIP_EXTRA_INDEX_URL}
ENV UV_EXTRA_INDEX_URL=${PIP_EXTRA_INDEX_URL}
ENV UV_INDEX_STRATEGY="unsafe-best-match"

# Install runtime deps first (same as builder)
COPY --from=builder /workspace/vllm/requirements/common.txt /tmp/requirements/common.txt
COPY --from=builder /workspace/vllm/requirements/cpu.txt /tmp/requirements/cpu.txt
RUN uv pip install --upgrade pip && \
    uv pip install \
        -r /tmp/requirements/common.txt \
        -r /tmp/requirements/cpu.txt && \
    rm -rf /tmp/requirements

# Install vLLM wheel
COPY --from=builder /workspace/vllm/dist/*.whl /tmp/
RUN uv pip install /tmp/*.whl && rm /tmp/*.whl

# Install manager
COPY manager/requirements.txt /opt/vllm-manager/requirements.txt
RUN uv pip install -r /opt/vllm-manager/requirements.txt
COPY manager/ /opt/vllm-manager/

# CPU environment
ENV MANAGER_PORT=8000
ENV VLLM_KEEP_ALIVE=5m
ENV VLLM_TARGET_DEVICE=cpu
ENV VLLM_CPU_KVCACHE_SPACE=4
ENV VLLM_CPU_OMP_THREADS_BIND=auto
ENV LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc_minimal.so.4
ENV PYTHONPATH=/opt/vllm-manager

EXPOSE 8000

# Single process - embedded engine, no subprocess
WORKDIR /opt/vllm-manager
ENTRYPOINT ["python3", "-m", "main"]
